name: Create Release

on:
  push:
    tags:
      - 'v*'  # Trigger bei Tag-Push (z.B. v1.0.0, v1.1.0)

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Erforderlich f√ºr Release-Erstellung
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Vollst√§ndige Git-Historie f√ºr Versions-Info
      
      - name: Extract version from tag
        id: version
        run: |
          # Entferne 'v' Pr√§fix vom Tag (v1.0.0 ‚Üí 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Version: $VERSION"
          echo "‚úÖ Tag: $GITHUB_REF_NAME"
      
      - name: Read version from composer.json
        id: composer-version
        run: |
          if [ -f composer.json ]; then
            COMPOSER_VERSION=$(grep -o '"version": "[^"]*"' composer.json | cut -d'"' -f4)
            echo "composer-version=$COMPOSER_VERSION" >> $GITHUB_OUTPUT
            echo "‚úÖ Composer Version: $COMPOSER_VERSION"
          else
            echo "‚ö†Ô∏è composer.json nicht gefunden"
          fi
      
      - name: Validate version match
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          COMPOSER_VERSION="${{ steps.composer-version.outputs.composer-version }}"
          
          if [ "$TAG_VERSION" != "$COMPOSER_VERSION" ]; then
            echo "‚ö†Ô∏è WARNUNG: Tag-Version ($TAG_VERSION) stimmt nicht mit composer.json Version ($COMPOSER_VERSION) √ºberein"
            echo "‚ÑπÔ∏è Verwende Tag-Version: $TAG_VERSION"
          else
            echo "‚úÖ Versionen stimmen √ºberein: $TAG_VERSION"
          fi
      
      - name: Create ZIP file
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="hero-blocks-${VERSION}.zip"
          
          echo "üì¶ Erstelle ZIP-Datei: ${ZIP_NAME}"
          
          # Erstelle ZIP mit git archive (nur versionierte Dateien)
          git archive --format=zip --output="${ZIP_NAME}" HEAD
          
          # Pr√ºfe ZIP-Datei
          if [ ! -f "${ZIP_NAME}" ]; then
            echo "‚ùå Fehler: ZIP-Datei wurde nicht erstellt"
            exit 1
          fi
          
          ZIP_SIZE=$(du -h "${ZIP_NAME}" | cut -f1)
          echo "‚úÖ ZIP-Datei erstellt: ${ZIP_NAME} (${ZIP_SIZE})"
          
          # Pr√ºfe ZIP-Inhalt
          echo "üìã Pr√ºfe ZIP-Inhalt..."
          if unzip -l "${ZIP_NAME}" | grep -q "composer.json"; then
            echo "‚úÖ composer.json gefunden"
          else
            echo "‚ùå WARNUNG: composer.json nicht in ZIP gefunden!"
            exit 1
          fi
          
          if unzip -l "${ZIP_NAME}" | grep -q "src/HeroBlocks.php"; then
            echo "‚úÖ src/HeroBlocks.php gefunden"
          else
            echo "‚ùå WARNUNG: src/HeroBlocks.php nicht in ZIP gefunden!"
            exit 1
          fi
          
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
      
      - name: Generate release notes
        id: release-notes
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Versuche RELEASE_NOTES.md zu lesen
          if [ -f RELEASE_NOTES.md ]; then
            echo "‚úÖ Verwende RELEASE_NOTES.md"
            NOTES=$(cat RELEASE_NOTES.md)
          else
            echo "‚ö†Ô∏è RELEASE_NOTES.md nicht gefunden, erstelle Standard-Notes"
            NOTES=$(cat <<EOF
## Hero Blocks v${VERSION}

### üéâ Release v${VERSION}

### Installation
1. Download hero-blocks-${VERSION}.zip
2. Shopware Admin ‚Üí Settings ‚Üí Extensions ‚Üí Upload Plugin
3. Install and activate plugin

### Requirements
- Shopware 6.7+
- PHP 8.1+

### Documentation
- See README.md for detailed documentation
EOF
)
          fi
          
          # Escape f√ºr GitHub Actions
          NOTES="${NOTES//$'\n'/'%0A'}"
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: ${{ steps.release-notes.outputs.notes }}
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release created
        run: |
          echo "üéâ Release erfolgreich erstellt!"
          echo "üì¶ ZIP: hero-blocks-${{ steps.version.outputs.version }}.zip"
          echo "üè∑Ô∏è  Tag: ${{ steps.version.outputs.tag }}"
          echo "üîó URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"

