{
    "nodes": [
        {
            "parameters": {
                "path": "hero-blocks",
                "responseMode": "responseNode",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Content-Type",
                                "value": "application/json"
                            }
                        ]
                    }
                }
            },
            "id": "665f6542-83c4-4b96-8a5c-9dea86fe5ede",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                -1184,
                176
            ],
            "webhookId": "hero-blocks-unified"
        },
        {
            "parameters": {
                "jsCode": "// WICHTIG: Route-Bestimmung basierend auf Query-Parameter (n8n Best Practice!)\n// Best Practices: Robust, sauber, eindeutige Logik gemäß n8n Dokumentation\n// n8n Webhook Path: hero-blocks (relativ zum Webhook-Base /webhook/)\n// Vollständiger Path: /webhook/hero-blocks?checkType=license oder /webhook/hero-blocks?checkType=update\n// Gemäß n8n Docs: Query-Parameter werden in query zurückgegeben\n\nlet checkType = null;\n\n// Step 1: Versuche Query-Parameter checkType (PRIMÄR - n8n Best Practice!)\n// n8n gibt Query-Parameter in $input.item.json.query zurück\nconst queryParams = $input.item.json.query || {};\nif (queryParams.checkType) {\n  checkType = String(queryParams.checkType).toLowerCase().trim();\n}\n\n// Step 2: Extrahiere aus webhookUrl (Fallback - falls Query-Parameter nicht verfügbar)\n// URL-Format: https://n8n.chooomedia.com/webhook/license/hero-blocks\n// oder: https://n8n.chooomedia.com/webhook/update/hero-blocks\n// ODER: https://n8n.chooomedia.com/webhook/hero-blocks?checkType=license\nif (!checkType && $input.item.json.webhookUrl) {\n  const url = String($input.item.json.webhookUrl);\n  // Matche: /webhook/license/hero-blocks oder /webhook/update/hero-blocks (altes Format)\n  const urlMatch = url.match(/\\/webhook\\/(license|update)\\/hero-blocks/i);\n  if (urlMatch && urlMatch[1]) {\n    checkType = urlMatch[1].toLowerCase().trim(); // 'license' oder 'update'\n  } else {\n    // Versuche Query-Parameter aus URL\n    const urlObj = new URL(url);\n    const checkTypeParam = urlObj.searchParams.get('checkType');\n    if (checkTypeParam) {\n      checkType = checkTypeParam.toLowerCase().trim();\n    }\n  }\n}\n\n// Step 3: Fallback: Versuche aus Request-URL zu extrahieren\nif (!checkType && $input.item.json.url) {\n  const url = String($input.item.json.url);\n  // Matche: /webhook/license/hero-blocks oder /webhook/update/hero-blocks\n  const urlMatch = url.match(/\\/(license|update)\\//i);\n  if (urlMatch && urlMatch[1]) {\n    checkType = urlMatch[1].toLowerCase().trim();\n  } else {\n    // Versuche Query-Parameter aus URL\n    try {\n      const urlObj = new URL(url);\n      const checkTypeParam = urlObj.searchParams.get('checkType');\n      if (checkTypeParam) {\n        checkType = checkTypeParam.toLowerCase().trim();\n      }\n    } catch (e) {\n      // URL parsing fehlgeschlagen - ignoriere\n    }\n  }\n}\n\n// Step 4: Default: license (für Backwards Compatibility)\nif (!checkType || (checkType !== 'license' && checkType !== 'update')) {\n  checkType = 'license';\n}\n\n// Return mit checkType und allen Query-Parametern\nreturn {\n  json: {\n    ...$input.item.json,\n    checkType: checkType,\n    // Query-Parameter explizit weitergeben (Best Practice)\n    plugin: queryParams.plugin || $input.item.json.plugin || 'hero-blocks',\n    version: queryParams.version || $input.item.json.version || '1.0.0',\n    shopwareVersion: queryParams.shopwareVersion || $input.item.json.shopwareVersion || '6.7.0',\n    timestamp: queryParams.timestamp || queryParams.checkDate || $input.item.json.timestamp || new Date().toISOString(),\n    currentVersion: queryParams.currentVersion || queryParams.version || '1.0.0'\n  }\n};"
            },
            "id": "dee1d764-aa7d-4422-bf03-005c1adda54f",
            "name": "Code (Determine Check Type)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -992,
                176
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 1
                    },
                    "conditions": [
                        {
                            "id": "3f048ca4-29b8-4e18-866d-391fd6e15f40",
                            "leftValue": "={{ $('Webhook').item.json.query.checkType }}",
                            "rightValue": "update",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "id": "329944e0-2a9c-4efd-b667-10cafeb07158",
            "name": "IF Check Type = License?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                -800,
                176
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "expiresAt",
                            "value": "2027-12-31T00:00:00+00:00"
                        }
                    ],
                    "number": [
                        {
                            "name": "daysRemaining",
                            "value": "={{ Math.max(0, Math.ceil((DateTime.fromISO('2027-12-31T00:00:00+00:00').toMillis() - $now.toMillis()) / 86400000)) }}"
                        }
                    ],
                    "boolean": [
                        {
                            "name": "valid",
                            "value": "={{ $now <= DateTime.fromISO('2027-12-31T00:00:00+00:00') }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "1a169c1a-f474-4fe2-bc11-32fecaafe5e8",
            "name": "Set (Compute License)",
            "type": "n8n-nodes-base.set",
            "typeVersion": 2,
            "position": [
                -464,
                432
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "boolean": [
                        {
                            "value1": "={{ $json.valid }}",
                            "value2": true
                        }
                    ]
                },
                "options": {}
            },
            "id": "45bcdec3-465f-4943-82b4-aefca998b83d",
            "name": "IF License Valid?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                -272,
                432
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ { valid: true, expiresAt: $json.expiresAt, daysRemaining: $json.daysRemaining } }}",
                "options": {}
            },
            "id": "391467e0-c678-4c65-ad0c-9021c9d9b2d3",
            "name": "Respond (License Valid)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                400,
                336
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ { valid: false, expiresAt: $json.expiresAt, daysRemaining: $json.daysRemaining } }}",
                "options": {}
            },
            "id": "84371e9e-edb1-4a72-be7d-3fdf5ad1d03d",
            "name": "Respond (License Invalid)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                400,
                496
            ]
        },
        {
            "parameters": {
                "operation": "getLatestRelease",
                "owner": "={{ $env.GITHUB_OWNER || 'chooomedia' }}",
                "repository": "={{ $env.GITHUB_REPO || 'hero-blocks' }}"
            },
            "id": "8e90c13f-079f-461a-9788-50a3316ea0e5",
            "name": "GitHub (Get Latest Release)",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [
                -464,
                -64
            ],
            "webhookId": "cf9d9063-fa8c-4f5b-bc57-956c0a7668b0",
            "credentials": {
                "githubApi": {
                    "id": "lrNvOKmSqXVhTpHk",
                    "name": "GitHub account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// WICHTIG: Verarbeite GitHub Releases API Response\n// Best Practices: Robust, sauber, eindeutige Logik\n// Gemäß GitHub API Dokumentation: Releases API gibt tag_name, assets, body zurück\n\n// 1. Lese GitHub API Response\nconst githubResponse = $input.item.json;\nconst currentVersion = $input.item.json.query?.currentVersion || '1.0.0';\n\n// 2. Extrahiere Latest Version aus GitHub Tag\n// GitHub Tag Format: \"v1.1.0\" → \"1.1.0\"\nlet latestVersion = null;\nif (githubResponse.tag_name) {\n  latestVersion = githubResponse.tag_name.replace(/^v/, ''); // Remove \"v\" prefix\n}\n\n// 3. Finde .zip Asset für Download URL\nlet downloadUrl = null;\nif (githubResponse.assets && Array.isArray(githubResponse.assets)) {\n  const zipAsset = githubResponse.assets.find(asset => \n    asset.name && asset.name.endsWith('.zip')\n  );\n  if (zipAsset && zipAsset.browser_download_url) {\n    downloadUrl = zipAsset.browser_download_url;\n  }\n}\n\n// 4. Extrahiere Changelog aus Release Body\nconst changelog = githubResponse.body || githubResponse.body_text || 'No changelog available';\n\n// 5. Speichere GitHub Response Daten für Version-Vergleich\nreturn {\n  json: {\n    ...$input.item.json,\n    latestVersion: latestVersion || currentVersion,\n    downloadUrl: downloadUrl || null,\n    changelog: changelog,\n    currentVersion: currentVersion,\n    githubTag: githubResponse.tag_name || null,\n    githubPublishedAt: githubResponse.published_at || null\n  }\n};"
            },
            "id": "94cb1818-d1bd-4e3b-82b5-47907e974054",
            "name": "Code (Process GitHub Response)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -256,
                -64
            ]
        },
        {
            "parameters": {
                "jsCode": "// WICHTIG: Version-Vergleich für Update-Check\n// Best Practices: Semantic Versioning, robust, sauber\n// Harmoniert mit GitHub Releases API Response\n\n// 1. Lese aktuelle Version aus Query-Parametern\nconst currentVersion = $input.item.json.query?.currentVersion || $input.item.json.currentVersion || '1.0.0';\n\n// 2. Lese neueste Version aus GitHub Response (bereits verarbeitet)\nconst latestVersion = $input.item.json.latestVersion || '1.0.0';\n\n// 3. Version-Vergleich (Semantic Versioning)\nfunction compareVersions(v1, v2) {\n  const parts1 = v1.split('.').map(Number);\n  const parts2 = v2.split('.').map(Number);\n  \n  for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {\n    const part1 = parts1[i] || 0;\n    const part2 = parts2[i] || 0;\n    \n    if (part1 < part2) return -1;\n    if (part1 > part2) return 1;\n  }\n  \n  return 0;\n}\n\n// 4. Prüfe ob Update verfügbar ist\nconst updateAvailable = latestVersion && compareVersions(currentVersion, latestVersion) < 0;\n\n// 5. Generiere Update-Informationen\n// WICHTIG: downloadUrl und changelog werden bereits aus GitHub Response extrahiert\nreturn {\n  json: {\n    ...$input.item.json,\n    available: updateAvailable,\n    currentVersion,\n    latestVersion,\n    // downloadUrl und changelog bereits vorhanden (aus GitHub Response)\n    downloadUrl: updateAvailable ? ($input.item.json.downloadUrl || null) : null,\n    changelog: updateAvailable ? ($input.item.json.changelog || null) : null\n  }\n};"
            },
            "id": "8cdbed17-d201-49c5-afa3-a4a443d33185",
            "name": "Code (Compare Versions)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -48,
                -64
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict"
                    },
                    "boolean": [
                        {
                            "value1": "={{ $json.available }}",
                            "value2": true
                        }
                    ]
                },
                "options": {}
            },
            "id": "aac8868e-6522-440f-a6f4-de9d3908f43d",
            "name": "IF Update Available?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2,
            "position": [
                192,
                -64
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ { available: true, currentVersion: $json.currentVersion, latestVersion: $json.latestVersion, downloadUrl: $json.downloadUrl, changelog: $json.changelog } }}",
                "options": {}
            },
            "id": "d440eb19-b3e2-48b8-8dc0-895e09cf7f9a",
            "name": "Respond (Update Available)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                400,
                -160
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ { available: false, currentVersion: $json.currentVersion, latestVersion: $json.latestVersion } }}",
                "options": {}
            },
            "id": "3641733f-fa9b-4ce2-927a-86d5e77fe48f",
            "name": "Respond (No Update)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                400,
                16
            ]
        },
        {
            "parameters": {
                "content": "## License Check ",
                "height": 400,
                "width": 1056
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -512,
                272
            ],
            "id": "ff24e518-5fae-4d35-aef1-aa612e133b15",
            "name": "Sticky Note"
        },
        {
            "parameters": {
                "content": "## Update Check ",
                "height": 416,
                "width": 1056
            },
            "type": "n8n-nodes-base.stickyNote",
            "typeVersion": 1,
            "position": [
                -512,
                -192
            ],
            "id": "de83f538-fdbc-4faa-9fb6-09a2ceb9a802",
            "name": "Sticky Note1"
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Code (Determine Check Type)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code (Determine Check Type)": {
            "main": [
                [
                    {
                        "node": "IF Check Type = License?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "IF Check Type = License?": {
            "main": [
                [
                    {
                        "node": "GitHub (Get Latest Release)",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Set (Compute License)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set (Compute License)": {
            "main": [
                [
                    {
                        "node": "IF License Valid?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "IF License Valid?": {
            "main": [
                [
                    {
                        "node": "Respond (License Valid)",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Respond (License Invalid)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "GitHub (Get Latest Release)": {
            "main": [
                [
                    {
                        "node": "Code (Process GitHub Response)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code (Process GitHub Response)": {
            "main": [
                [
                    {
                        "node": "Code (Compare Versions)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code (Compare Versions)": {
            "main": [
                [
                    {
                        "node": "IF Update Available?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "IF Update Available?": {
            "main": [
                [
                    {
                        "node": "Respond (Update Available)",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Respond (No Update)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {
        "Webhook": [
            {
                "headers": {
                    "host": "n8n.chooomedia.com",
                    "user-agent": "Shopware-HeroBlocks-Plugin/1.0.0",
                    "accept": "application/json",
                    "x-forwarded-for": "157.143.70.83",
                    "x-forwarded-host": "n8n.chooomedia.com",
                    "x-forwarded-proto": "https",
                    "accept-encoding": "gzip"
                },
                "params": {},
                "query": {
                    "checkType": "update",
                    "plugin": "hero-blocks",
                    "currentVersion": "1.0.0",
                    "shopwareVersion": "6.7.0",
                    "timestamp": "2025-11-15T08:29:58+00:00"
                },
                "webhookUrl": "https://n8n.chooomedia.com/webhook/hero-blocks",
                "executionMode": "production"
            }
        ]
    },
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "3dae61a0a24f0b093f057680559772c3c73ec97ec47a9bd2a5ad745c7d8f0365"
    }
}