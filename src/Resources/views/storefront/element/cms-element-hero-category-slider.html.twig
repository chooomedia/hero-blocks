{% block element_hero_category_slider %}
    {# V3.0 - Category Slider mit Slide-Management nach Mockup #}
    
    {# CONFIG LADEN #}
    {% set elementConfig = element.fieldConfig.elements %}
    {% set blockConfig = block.customFields %}
    {% set sliderConfig = {
        navigationArrows: { value: blockConfig.navigationArrows|default(elementConfig.navigationArrows.value|default('outside')) },
        navigationDots: { value: blockConfig.navigationDots|default(elementConfig.navigationDots.value|default(true)) },
        autoSlide: { value: blockConfig.autoSlide|default(elementConfig.autoSlide.value|default(false)) },
        autoplayTimeout: { value: blockConfig.autoplayTimeout|default(elementConfig.autoplayTimeout.value|default(5000)) },
        speed: { value: blockConfig.speed|default(elementConfig.speed.value|default(300)) },
        displayMode: { value: elementConfig.displayMode.value|default('cover') },
        minHeight: { value: elementConfig.minHeight.value|default('240px') },
        maxHeight: { value: elementConfig.maxHeight.value|default(null) },
        verticalAlign: { value: elementConfig.verticalAlign.value|default(null) },
        imageCount: { value: elementConfig.imageCount.value|default('2') }
    } %}
    
    {% set visibleNavValues = ['inside', 'outside'] %}
    {% set visibleDotsValues = ['bottom'] %}
    {% set blockId = block.id %}
    {% set displayMode = sliderConfig.displayMode.value ?: 'cover' %}
    
    {# MinHeight & MaxHeight verarbeiten #}
    {% set minHeight = null %}
    {% if sliderConfig.minHeight.value %}
        {% set minHeightValue = sliderConfig.minHeight.value|trim %}
        {% if minHeightValue|length > 0 %}
            {% set minHeight = minHeightValue %}
        {% endif %}
    {% endif %}
    
    {% set maxHeight = null %}
    {% if sliderConfig.maxHeight.value %}
        {% set maxHeightValue = sliderConfig.maxHeight.value|trim %}
        {% if maxHeightValue|length > 0 %}
            {% set maxHeight = maxHeightValue %}
        {% endif %}
    {% endif %}
    
    {# ImageCount als Integer #}
    {% set imageCountInt = sliderConfig.imageCount.value|default(2)|number_format(0,'','')|abs %}
    
    {# LOGIK: Slider nur wenn mehr Slides als imageCount! #}
    {% set totalSlides = element.data.sliderItems|length %}
    {% set needsSlider = totalSlides > imageCountInt %}
    
    {# DEBUG in Console #}
    <script>
        console.log('[CategorySlider V3.0] imageCountInt:', {{ imageCountInt }}, 'Type:', typeof {{ imageCountInt }});
        console.log('[CategorySlider V3.0] totalSlides:', {{ totalSlides }});
        console.log('[CategorySlider V3.0] needsSlider:', {{ needsSlider ? 'true' : 'false' }});
        console.log('[CategorySlider V3.0] → Expected: 2 items per view');
    </script>

    <div class="cms-element-{{ element.type }}{% if displayMode == "standard" and sliderConfig.verticalAlign.value %} has-vertical-alignment{% endif %}">
        {% if needsSlider %}
            {# SLIDER MODUS - Wenn mehr Slides als imageCount #}
            {% set baseSliderOptions = {
                slider: {
                    items: imageCountInt,
                    controls: sliderConfig.navigationArrows.value in visibleNavValues,
                    nav: sliderConfig.navigationDots.value in visibleDotsValues,
                    navPosition: 'bottom',
                    mouseDrag: true,
                    autoplay: sliderConfig.autoSlide.value,
                    autoplayButtonOutput: false,
                    autoplayTimeout: sliderConfig.autoplayTimeout.value ?: 5000,
                    autoplayHoverPause: true,
                    speed: sliderConfig.speed.value|default(300)|round(0, 'floor'),
                    ariaLive: sliderConfig.autoSlide.value ? false : true,
                    autoHeight: false,
                    loop: false,
                    rewind: true,
                    gutter: 20,
                    responsive: {
                        0: {
                            items: 1,
                            gutter: 0
                        },
                        768: {
                            items: (imageCountInt < 2 ? 1 : 2),
                            gutter: 15
                        },
                        1024: {
                            items: imageCountInt,
                            gutter: 20
                        }
                    }
                }
            } %}
        {% endif %}

        {% block element_hero_category_slider_alignment %}
            {% if sliderConfig.verticalAlign.value %}
                <div class="cms-element-alignment{% if sliderConfig.verticalAlign.value == "center" %} align-self-center{% elseif sliderConfig.verticalAlign.value == "flex-end" %} align-self-end{% else %} align-self-start{% endif %}">
            {% endif %}
                <div
                    class="hero-category-slider{% if needsSlider %} base-slider{% endif %}{% if sliderConfig.navigationArrows.value == "outside" %} has-nav-outside{% endif %}{% if sliderConfig.navigationDots.value == "bottom" %} has-dots-bottom{% endif %}"
                    {% if needsSlider %}
                    data-base-slider="true"
                    data-base-slider-options='{{ baseSliderOptions|json_encode }}'
                    {% endif %}
                    role="region"
                    aria-label="{{ 'component.cms.imageGallery.ariaLabel'|trans({ '%total%': totalSlides })|sw_sanitize }}"
                    tabindex="0"
                    itemscope
                    itemtype="https://schema.org/ImageGallery"
                >
                    {% block element_hero_category_slider_skip_slider %}
                        {% sw_include '@Storefront/storefront/component/skip-target.html.twig' with {
                            targetId: blockId,
                            snippet: 'component.cms.imageGallery.skipImageGallery',
                        } %}
                    {% endblock %}

                    <div class="hero-category-slider-container{% if not needsSlider %} hero-category-slider-container--static row g-3{% endif %}"{% if needsSlider %} data-base-slider-container="true"{% endif %}>
                        {% if element.data.sliderItems is defined and element.data.sliderItems|length > 0 %}
                            {% for image in element.data.sliderItems %}
                                {% block element_hero_category_slider_item %}
                                    {# V3.0 - Slide Data aus Extensions #}
                                    {% set slideTitle = image.extensions.customTitle.value ?? image.extensions.categoryTitle.value ?? 'Category' %}
                                    {% set slideText = image.extensions.customText.value ?? null %}
                                    {% set slideLink = image.extensions.customLink.value ?? image.extensions.categoryLink.value ?? null %}
                                    {% set slideNewTab = image.extensions.newTab.value ?? false %}
                                    {% set hasCustomImage = image.extensions.hasCustomImage.value ?? false %}
                                    
                                    {# BOOTSTRAP RESPONSIVE CLASSES - col für static mode #}
                                    <div 
                                        class="hero-category-slider-item-container mt-0{% if not needsSlider %} col-12 col-md-{{ 12 / imageCountInt }}{% endif %}"
                                        {% if loop.index > imageCountInt %}aria-hidden="true"{% endif %}
                                        itemscope
                                        itemtype="https://schema.org/ImageObject"
                                    >
                                        {# LINK um GESAMTEN Wrapper #}
                                        {% if slideLink %}
                                        <a 
                                            href="{{ slideLink }}"
                                            class="hero-category-slide-link"
                                            {% if slideNewTab %}target="_blank" rel="noopener noreferrer"{% endif %}
                                            aria-label="{{ 'component.cms.categorySlider.goToCategory'|trans({ '%name%': slideTitle|striptags })|sw_sanitize }}"
                                            itemprop="url"
                                        >
                                        {% endif %}
                                        
                                        <div class="hero-category-slider-item is-{{ displayMode }}"
                                            style="{% if minHeight %}min-height: {{ minHeight }};{% endif %}{% if maxHeight %} max-height: {{ maxHeight }};{% endif %}"
                                        >
                                            {# BACKGROUND MIT BILD (Zoom-Effekt auf Hover) #}
                                            <div class="hero-category-slide-background is-{{ displayMode }}">
                                                {% if image.media %}
                                                    {# ECHTES BILD VORHANDEN #}
                                                    {% set imageAltText = slideTitle %}
                                                    {% if hasCustomImage %}
                                                        {% set imageAltText = (image.media.translated.alt ?: slideTitle) %}
                                                    {% endif %}
                                                    
                                                    {% set imageAttributes = {
                                                        'class': 'hero-category-slide-img img-fluid w-100 h-100',
                                                        'loading': loop.first ? 'eager' : 'lazy',
                                                        'alt': imageAltText|striptags,
                                                        'title': image.media.translated.title ?: slideTitle|striptags,
                                                        'itemprop': 'contentUrl'
                                                    } %}
                                                    
                                                    {% if displayMode == 'cover' or displayMode == 'contain' %}
                                                        {% set imageAttributes = imageAttributes|merge({ 'data-object-fit': displayMode }) %}
                                                    {% endif %}
                                                    
                                                    {% sw_thumbnails 'hero-category-slide-thumbnails' with {
                                                        media: image.media,
                                                        sizes: {
                                                            'xs': '375px',
                                                            'sm': '768px',
                                                            'md': '1024px',
                                                            'lg': '1440px',
                                                            'xl': '1920px',
                                                            'default': '1920px'
                                                        },
                                                        attributes: imageAttributes
                                                    } %}
                                                {% else %}
                                                    {# KEIN BILD - PLACEHOLDER #}
                                                    <img 
                                                        src="{{ asset('bundles/heroblocks/assets/placeholder.svg') }}"
                                                        alt="{{ slideTitle|striptags }}"
                                                        class="hero-category-slide-img img-fluid w-100 h-100"
                                                        style="object-fit: contain; opacity: 0.3;"
                                                    />
                                                {% endif %}
                                                
                                                {# TITLE - OBEN LINKS (weiß, Oswald) #}
                                                {% if slideTitle %}
                                                <div class="hero-category-slide-title-wrapper">
                                                    <h3 class="hero-category-slide-title" itemprop="name">
                                                        {{ slideTitle }}
                                                    </h3>
                                                </div>
                                                {% endif %}
                                                
                                                {# BUTTON - OBEN RECHTS Desktop, UNTER TITLE Mobile #}
                                                <div class="hero-category-slide-button-wrapper">
                                                    <span class="btn btn-light hero-category-slide-button">
                                                        {{ 'component.cms.categorySlider.moreInfo'|trans|sw_sanitize }}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <meta itemprop="position" content="{{ loop.index }}">
                                        </div>
                                        
                                        {% if slideLink %}
                                        </a>
                                        {% endif %}
                                    </div>
                                {% endblock %}
                            {% endfor %}
                        {% endif %}
                    </div>

                    {# EMPTY STATE - Platzhalter #}
                    {% if not element.data.sliderItems or element.data.sliderItems|length == 0 %}
                        <div class="hero-category-slider-placeholder-wrapper row g-3">
                            {% set imageCountNum = imageCountInt|default(2) %}
                            {% for i in 1..imageCountNum %}
                                <div class="hero-category-slider-placeholder-item col-12 col-md-{{ 12 / imageCountNum }}">
                                    <div class="hero-category-slider-placeholder-content" style="{% if minHeight %}min-height: {{ minHeight }};{% endif %}{% if maxHeight %} max-height: {{ maxHeight }};{% endif %}">
                                        <img
                                            src="{{ asset('bundles/heroblocks/assets/placeholder.svg') }}"
                                            alt="{{ 'component.cms.categorySlider.noImages'|trans|sw_sanitize }}"
                                            class="hero-category-slider-placeholder-img"
                                        />
                                        <p class="hero-category-slider-placeholder-text">{{ 'component.cms.categorySlider.noImages'|trans|sw_sanitize }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# NAVIGATION - nur wenn needsSlider #}
                    {% if needsSlider and sliderConfig.navigationArrows.value in visibleNavValues %}
                        {% block element_hero_category_slider_controls %}
                            <div class="hero-category-slider-controls-container">
                                <div class="base-slider-controls" data-base-slider-controls="true">
                                    <button
                                        class="base-slider-controls-prev hero-category-slider-controls-prev{% if sliderConfig.navigationArrows.value == "outside" %} is-nav-prev-outside{% elseif sliderConfig.navigationArrows.value == "inside" %} is-nav-prev-inside{% endif %}"
                                        aria-label="{{ 'general.previous'|trans|striptags }}"
                                    >
                                        {% sw_icon 'arrow-head-left' %}
                                    </button>
                                    <button
                                        class="base-slider-controls-next hero-category-slider-controls-next{% if sliderConfig.navigationArrows.value == "outside" %} is-nav-next-outside{% elseif sliderConfig.navigationArrows.value == "inside" %} is-nav-next-inside{% endif %}"
                                        aria-label="{{ 'general.next'|trans|striptags }}"
                                    >
                                        {% sw_icon 'arrow-head-right' %}
                                    </button>
                                </div>
                            </div>
                        {% endblock %}
                    {% endif %}
                </div>
            {% if sliderConfig.verticalAlign.value %}
                </div>
            {% endif %}
        {% endblock %}
    </div>

    {# STYLES - Inline für schnelles Rendering #}
    <style>
        {# CONTAINER - WICHTIG: Für Tiny Slider! #}
        .hero-category-slider-container {
            width: 100%;
            max-width: 100%;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box;
        }
        
        .hero-category-slider-container--static {
            display: flex !important;
            flex-wrap: wrap !important; /* Bootstrap row flex-wrap */
        }
        
        {# ITEM WRAPPER - Minimales CSS für Tiny Slider! #}
        .hero-category-slider-item-container {
            /* Tiny Slider setzt: position, width, left via inline-styles */
        }
        
        {# WICHTIG: Im Static-Modus flex mit voller Höhe #}
        .hero-category-slider-container--static .hero-category-slider-item-container {
            display: flex;
            flex-direction: column;
        }
        
        .hero-category-slider-item {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: #000;
            min-height: 240px; /* Standard min-height */
            display: block;
            width: 100%;
        }
        
        {# KRITISCH: Static Mode braucht flex-grow! #}
        .hero-category-slider-container--static .hero-category-slider-item {
            flex: 1;
        }
        
        {# LINK um Wrapper - KRITISCH: Muss 100% Höhe haben! #}
        .hero-category-slide-link {
            display: block;
            text-decoration: none;
            color: inherit;
            transition: transform 0.3s ease;
            height: 100%;
            width: 100%;
        }
        
        .hero-category-slide-link:hover {
            transform: translateY(-4px);
        }
        
        {# KRITISCH: Static Mode Link braucht flex! #}
        .hero-category-slider-container--static .hero-category-slide-link {
            display: flex;
            flex-direction: column;
        }
        
        {# BACKGROUND - KRITISCH: Muss Höhe von Parent erben! #}
        .hero-category-slide-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        {# IMAGE mit Zoom-Effekt #}
        .hero-category-slide-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.6s ease;
            z-index: 1;
            object-fit: cover;
            object-position: center;
        }
        
        .hero-category-slide-background.is-contain .hero-category-slide-img {
            object-fit: contain;
        }
        
        .hero-category-slide-link:hover .hero-category-slide-img {
            transform: scale(1.1);
        }
        
        {# TITLE - OBEN LINKS #}
        .hero-category-slide-title-wrapper {
            position: absolute;
            top: 2rem;
            left: 2rem;
            z-index: 10;
            max-width: calc(100% - 200px);
        }
        
         .hero-category-slide-title {
             color: #fff;
             font-family: 'Oswald', sans-serif;
             font-size: 2rem; /* Bootstrap h2 size */
             font-weight: 600;
             line-height: 1.2;
             margin: 0;
             text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
         }
        
        {# BUTTON - OBEN RECHTS Desktop, RECHTS UNTEN Mobile #}
        .hero-category-slide-button-wrapper {
            position: absolute;
            top: 2rem;
            right: 2rem;
            z-index: 10;
        }
        
         .hero-category-slide-button {
             font-family: 'Oswald', sans-serif !important;
             font-weight: 500 !important;
             font-size: 0.875rem !important; /* Bootstrap btn-sm size */
             background-color: rgba(255, 255, 255, 0.9) !important;
             color: #333 !important;
             border: none !important;
             padding: 0.5rem 1.25rem !important; /* Bootstrap btn-sm padding */
             border-radius: 0.25rem !important; /* Bootstrap default radius */
             transition: all 0.3s ease !important;
             display: inline-block !important;
             text-decoration: none !important;
             cursor: pointer !important;
             white-space: nowrap !important;
         }
        
        .hero-category-slide-link:hover .hero-category-slide-button {
            background-color: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        {# PLACEHOLDER #}
        .hero-category-slider-placeholder-wrapper {
            padding: 2rem 0;
        }
        
        .hero-category-slider-placeholder-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background-color: #F3F4F6;
            border-radius: 8px;
            padding: 2rem;
        }
        
        .hero-category-slider-placeholder-img {
            max-width: 200px;
            width: 100%;
            height: auto;
            opacity: 0.6;
        }
        
        .hero-category-slider-placeholder-text {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #6B7280;
            text-align: center;
        }
        
         {# RESPONSIVE - MOBILE #}
         @media screen and (max-width: 767px) {
             .hero-category-slide-title {
                 font-size: 1.5rem;
             }
             
             .hero-category-slide-title-wrapper {
                 top: 1rem;
                 left: 1rem;
                 max-width: calc(100% - 2rem);
             }
             
             .hero-category-slide-button-wrapper {
                 top: 1rem;
                 right: 1rem;
             }
             
             .hero-category-slide-button {
                 font-size: 0.75rem !important;
                 padding: 0.375rem 0.875rem !important;
             }
         }
         
         {# RESPONSIVE - TABLET #}
         @media screen and (min-width: 768px) and (max-width: 1023px) {
             .hero-category-slide-title {
                 font-size: 1.75rem;
             }
         }
        
        {# NAVIGATION - WIE HERO SLIDER (auf Hover anzeigen) #}
        .hero-category-slider.has-nav-outside .hero-category-slider-controls-prev,
        .hero-category-slider.has-nav-outside .hero-category-slider-controls-next {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .hero-category-slider.has-nav-outside:hover .hero-category-slider-controls-prev,
        .hero-category-slider.has-nav-outside:hover .hero-category-slider-controls-next {
            opacity: 1;
        }
        
         {# DOTS STYLING - DUNKEL wie gewünscht! #}
         .hero-category-slider .tns-nav {
             margin-top: 1.5rem;
             text-align: center;
         }
         
         .hero-category-slider .tns-nav button {
             width: 10px;
             height: 10px;
             border-radius: 50%;
             border: 2px solid rgba(61, 62, 66, 0.4); /* Dunkel statt weiß! */
             background: transparent;
             transition: all 0.3s ease;
             margin: 0 0.35rem;
         }
         
         .hero-category-slider .tns-nav button.tns-nav-active {
             background: rgba(61, 62, 66, 0.8); /* Dunkel für aktiv! */
             border-color: rgba(61, 62, 66, 0.8);
             transform: scale(1.2);
         }
         
         .hero-category-slider .tns-nav button:hover {
             border-color: rgba(61, 62, 66, 0.6);
             background: rgba(61, 62, 66, 0.3);
         }
    </style>

    {% block element_hero_category_slider_target_after_slider %}
        <div id="content-after-target-{{ blockId }}"></div>
    {% endblock %}
{% endblock %}
