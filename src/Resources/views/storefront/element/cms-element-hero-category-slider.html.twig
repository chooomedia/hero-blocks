{% block element_hero_category_slider %}
    {# V3.0 - Category Slider mit Slide-Management nach Mockup #}
    
    {# CONFIG LADEN #}
    {% set elementConfig = element.fieldConfig.elements %}
    {% set blockConfig = block.customFields %}
    {% set sliderConfig = {
        navigationArrows: { value: blockConfig.navigationArrows|default(elementConfig.navigationArrows.value|default('outside')) },
        navigationDots: { value: blockConfig.navigationDots|default(elementConfig.navigationDots.value|default(true)) },
        autoSlide: { value: blockConfig.autoSlide|default(elementConfig.autoSlide.value|default(false)) },
        autoplayTimeout: { value: blockConfig.autoplayTimeout|default(elementConfig.autoplayTimeout.value|default(5000)) },
        speed: { value: blockConfig.speed|default(elementConfig.speed.value|default(300)) },
        displayMode: { value: elementConfig.displayMode.value|default('cover') },
        minHeight: { value: elementConfig.minHeight.value|default('240px') },
        maxHeight: { value: elementConfig.maxHeight.value|default(null) },
        verticalAlign: { value: elementConfig.verticalAlign.value|default(null) },
        imageCount: { value: elementConfig.imageCount.value|default('2') }
    } %}
    
    {% set visibleNavValues = ['inside', 'outside'] %}
    {% set visibleDotsValues = ['bottom'] %}
    {% set blockId = block.id %}
    {% set displayMode = sliderConfig.displayMode.value ?: 'cover' %}
    
    {# MinHeight & MaxHeight verarbeiten #}
    {% set minHeight = null %}
    {% if sliderConfig.minHeight.value %}
        {% set minHeightValue = sliderConfig.minHeight.value|trim %}
        {% if minHeightValue|length > 0 %}
            {% set minHeight = minHeightValue %}
        {% endif %}
    {% endif %}
    
    {% set maxHeight = null %}
    {% if sliderConfig.maxHeight.value %}
        {% set maxHeightValue = sliderConfig.maxHeight.value|trim %}
        {% if maxHeightValue|length > 0 %}
            {% set maxHeight = maxHeightValue %}
        {% endif %}
    {% endif %}
    
    {# ImageCount als Integer #}
    {% set imageCountInt = sliderConfig.imageCount.value|default(2)|number_format(0,'','')|abs %}
    
    {# LOGIK: Slider nur wenn mehr Slides als imageCount! #}
    {% set totalSlides = element.data.sliderItems|length %}
    {% set needsSlider = totalSlides > imageCountInt %}
    
    <div class="cms-element-{{ element.type }}{% if displayMode == "standard" and sliderConfig.verticalAlign.value %} has-vertical-alignment{% endif %}">
        {% if needsSlider %}
            {# SLIDER MODUS - Wenn mehr Slides als imageCount #}
            {% set baseSliderOptions = {
                slider: {
                    items: imageCountInt,
                    controls: sliderConfig.navigationArrows.value in visibleNavValues,
                    nav: sliderConfig.navigationDots.value in visibleDotsValues,
                    navPosition: 'bottom',
                    mouseDrag: true,
                    autoplay: sliderConfig.autoSlide.value,
                    autoplayButtonOutput: false,
                    autoplayTimeout: sliderConfig.autoplayTimeout.value ?: 5000,
                    autoplayHoverPause: true,
                    speed: sliderConfig.speed.value|default(300)|round(0, 'floor'),
                    ariaLive: sliderConfig.autoSlide.value ? false : true,
                    autoHeight: false,
                    loop: false,
                    rewind: true,
                    gutter: 20,
                    responsive: {
                        0: {
                            items: 1,
                            gutter: 0
                        },
                        768: {
                            items: (imageCountInt < 2 ? 1 : 2),
                            gutter: 15
                        },
                        1024: {
                            items: imageCountInt,
                            gutter: 20
                        }
                    }
                }
            } %}
        {% endif %}

        {% block element_hero_category_slider_alignment %}
            {% if sliderConfig.verticalAlign.value %}
                <div class="cms-element-alignment{% if sliderConfig.verticalAlign.value == "center" %} align-self-center{% elseif sliderConfig.verticalAlign.value == "flex-end" %} align-self-end{% else %} align-self-start{% endif %}">
            {% endif %}
                <div
                    class="hero-category-slider{% if needsSlider %} base-slider{% endif %}{% if sliderConfig.navigationArrows.value == "outside" %} has-nav-outside{% endif %}{% if sliderConfig.navigationDots.value == "bottom" %} has-dots-bottom{% endif %}"
                    {% if needsSlider %}
                    data-base-slider="true"
                    data-base-slider-options='{{ baseSliderOptions|json_encode }}'
                    {% endif %}
                    role="region"
                    aria-label="{{ 'component.cms.imageGallery.ariaLabel'|trans({ '%total%': totalSlides })|sw_sanitize }}"
                    tabindex="0"
                    itemscope
                    itemtype="https://schema.org/ImageGallery"
                >
                    {# Skip-Link für Accessibility - nur für Screen Reader sichtbar #}
                    {% block element_hero_category_slider_skip_slider %}
                        <a href="#content-after-target-{{ blockId }}" class="visually-hidden-focusable">
                            {{ 'component.cms.imageGallery.skipImageGallery'|trans|sw_sanitize }}
                        </a>
                    {% endblock %}

                    {# V3.3 - Bootstrap Row/Col für Static Mode, Custom für Slider Mode #}
                    {% if needsSlider %}
                        {# SLIDER MODE - Tiny Slider kontrolliert das Layout #}
                        <div class="hero-category-slider-container" data-base-slider-container="true">
                            {% if element.data.sliderItems is defined and element.data.sliderItems|length > 0 %}
                                {% for image in element.data.sliderItems %}
                                    {% block element_hero_category_slider_item_slider %}
                                        {% set slideTitle = image.extensions.customTitle.value ?? image.extensions.categoryTitle.value ?? 'Category' %}
                                        {% set slideLink = image.extensions.customLink.value ?? image.extensions.categoryLink.value ?? null %}
                                        {% set slideNewTab = image.extensions.newTab.value ?? false %}
                                        {% set hasCustomImage = image.extensions.hasCustomImage.value ?? false %}
                                        
                                        <div class="hero-category-slider-item-container" itemscope itemtype="https://schema.org/ImageObject">
                                            {% if slideLink %}
                                            <a href="{{ slideLink }}" class="hero-category-slide-link d-block h-100"
                                               {% if slideNewTab %}target="_blank" rel="noopener noreferrer"{% endif %}
                                               aria-label="{{ 'component.cms.categorySlider.goToCategory'|trans({ '%name%': slideTitle|striptags })|sw_sanitize }}"
                                               itemprop="url">
                                            {% endif %}
                                                <div class="hero-category-slider-item position-relative overflow-hidden rounded is-{{ displayMode }}"
                                                     style="{% if minHeight %}min-height: {{ minHeight }};{% endif %}{% if maxHeight %}max-height: {{ maxHeight }};{% endif %}">
                                                    {# BACKGROUND IMAGE #}
                                                    <div class="hero-category-slide-background position-absolute top-0 start-0 w-100 h-100">
                                                        {% if image.media %}
                                                            {% set imageAltText = hasCustomImage ? (image.media.translated.alt ?: slideTitle) : slideTitle %}
                                                            {% sw_thumbnails 'hero-category-slide-thumbnails' with {
                                                                media: image.media,
                                                                sizes: { 'xs': '375px', 'sm': '768px', 'md': '1024px', 'lg': '1440px', 'xl': '1920px', 'default': '1920px' },
                                                                attributes: {
                                                                    'class': 'hero-category-slide-img position-absolute top-0 start-0 w-100 h-100',
                                                                    'loading': loop.first ? 'eager' : 'lazy',
                                                                    'alt': imageAltText|striptags,
                                                                    'title': image.media.translated.title ?: slideTitle|striptags,
                                                                    'itemprop': 'contentUrl',
                                                                    'data-object-fit': displayMode
                                                                }
                                                            } %}
                                                        {% else %}
                                                            <img src="{{ asset('bundles/heroblocks/assets/placeholder.svg') }}" alt="{{ slideTitle|striptags }}"
                                                                 class="hero-category-slide-img position-absolute top-0 start-0 w-100 h-100" style="object-fit: contain; opacity: 0.3;"/>
                                                        {% endif %}
                                                    </div>
                                                    {# CONTENT OVERLAY #}
                                                    {% if slideTitle %}
                                                    <div class="hero-category-slide-title-wrapper position-absolute" style="top: 1rem; left: 1rem; z-index: 10;">
                                                        <h3 class="hero-category-slide-title m-0 text-white" itemprop="name">{{ slideTitle }}</h3>
                                                    </div>
                                                    {% endif %}
                                                    <div class="hero-category-slide-button-wrapper position-absolute" style="top: 1rem; right: 1rem; z-index: 10;">
                                                        <span class="btn btn-light hero-category-slide-button">{{ 'component.cms.categorySlider.moreInfo'|trans|sw_sanitize }}</span>
                                                    </div>
                                                    <meta itemprop="position" content="{{ loop.index }}">
                                                </div>
                                            {% if slideLink %}</a>{% endif %}
                                        </div>
                                    {% endblock %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% else %}
                        {# STATIC MODE - Bootstrap Grid für 2 Spalten nebeneinander #}
                        <div class="row g-3 hero-category-slider-container--static">
                            {% if element.data.sliderItems is defined and element.data.sliderItems|length > 0 %}
                                {% for image in element.data.sliderItems %}
                                    {% block element_hero_category_slider_item_static %}
                                        {% set slideTitle = image.extensions.customTitle.value ?? image.extensions.categoryTitle.value ?? 'Category' %}
                                        {% set slideLink = image.extensions.customLink.value ?? image.extensions.categoryLink.value ?? null %}
                                        {% set slideNewTab = image.extensions.newTab.value ?? false %}
                                        {% set hasCustomImage = image.extensions.hasCustomImage.value ?? false %}
                                        
                                        {# Bootstrap col-12 für Mobile, col-md-6 für Desktop (2 Spalten) #}
                                        <div class="col-12 col-md-6 hero-category-slider-item-container" itemscope itemtype="https://schema.org/ImageObject">
                                            {% if slideLink %}
                                            <a href="{{ slideLink }}" class="hero-category-slide-link d-block h-100 text-decoration-none"
                                               {% if slideNewTab %}target="_blank" rel="noopener noreferrer"{% endif %}
                                               aria-label="{{ 'component.cms.categorySlider.goToCategory'|trans({ '%name%': slideTitle|striptags })|sw_sanitize }}"
                                               itemprop="url">
                                            {% endif %}
                                                <div class="hero-category-slider-item position-relative overflow-hidden rounded bg-dark is-{{ displayMode }}"
                                                     style="{% if minHeight %}min-height: {{ minHeight }};{% endif %}{% if maxHeight %}max-height: {{ maxHeight }};{% endif %}">
                                                    {# BACKGROUND IMAGE - position absolute, z-index 1 #}
                                                    <div class="hero-category-slide-background position-absolute top-0 start-0 w-100 h-100" style="z-index: 1;">
                                                        {% if image.media %}
                                                            {% set imageAltText = hasCustomImage ? (image.media.translated.alt ?: slideTitle) : slideTitle %}
                                                            {% sw_thumbnails 'hero-category-slide-thumbnails' with {
                                                                media: image.media,
                                                                sizes: { 'xs': '375px', 'sm': '768px', 'md': '1024px', 'lg': '1440px', 'xl': '1920px', 'default': '1920px' },
                                                                attributes: {
                                                                    'class': 'hero-category-slide-img position-absolute top-0 start-0 w-100 h-100',
                                                                    'loading': loop.first ? 'eager' : 'lazy',
                                                                    'alt': imageAltText|striptags,
                                                                    'title': image.media.translated.title ?: slideTitle|striptags,
                                                                    'itemprop': 'contentUrl',
                                                                    'data-object-fit': displayMode
                                                                }
                                                            } %}
                                                        {% else %}
                                                            <img src="{{ asset('bundles/heroblocks/assets/placeholder.svg') }}" alt="{{ slideTitle|striptags }}"
                                                                 class="hero-category-slide-img position-absolute top-0 start-0 w-100 h-100" style="object-fit: contain; opacity: 0.3;"/>
                                                        {% endif %}
                                                    </div>
                                                    {# CONTENT OVERLAY - z-index 10, über dem Bild #}
                                                    {% if slideTitle %}
                                                    <div class="hero-category-slide-title-wrapper position-absolute" style="top: 1rem; left: 1rem; z-index: 10; max-width: calc(100% - 150px);">
                                                        <h3 class="hero-category-slide-title m-0 text-white" itemprop="name">{{ slideTitle }}</h3>
                                                    </div>
                                                    {% endif %}
                                                    <div class="hero-category-slide-button-wrapper position-absolute" style="top: 1rem; right: 1rem; z-index: 10;">
                                                        <span class="btn btn-light hero-category-slide-button">{{ 'component.cms.categorySlider.moreInfo'|trans|sw_sanitize }}</span>
                                                    </div>
                                                    <meta itemprop="position" content="{{ loop.index }}">
                                                </div>
                                            {% if slideLink %}</a>{% endif %}
                                        </div>
                                    {% endblock %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endif %}

                    {# EMPTY STATE - Platzhalter #}
                    {% if not element.data.sliderItems or element.data.sliderItems|length == 0 %}
                        <div class="hero-category-slider-placeholder-wrapper hero-category-slider-container--static">
                            {% set imageCountNum = imageCountInt|default(2) %}
                            {% for i in 1..imageCountNum %}
                                <div class="hero-category-slider-placeholder-item hero-category-slider-item-container">
                                    <div class="hero-category-slider-placeholder-content" style="{% if minHeight %}min-height: {{ minHeight }};{% endif %}{% if maxHeight %} max-height: {{ maxHeight }};{% endif %}">
                                        <img
                                            src="{{ asset('bundles/heroblocks/assets/placeholder.svg') }}"
                                            alt="{{ 'component.cms.categorySlider.noImages'|trans|sw_sanitize }}"
                                            class="hero-category-slider-placeholder-img"
                                        />
                                        <p class="hero-category-slider-placeholder-text">{{ 'component.cms.categorySlider.noImages'|trans|sw_sanitize }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# NAVIGATION - nur wenn needsSlider #}
                    {% if needsSlider and sliderConfig.navigationArrows.value in visibleNavValues %}
                        {% block element_hero_category_slider_controls %}
                            <div class="hero-category-slider-controls-container">
                                <div class="base-slider-controls" data-base-slider-controls="true">
                                    <button
                                        class="base-slider-controls-prev hero-category-slider-controls-prev{% if sliderConfig.navigationArrows.value == "outside" %} is-nav-prev-outside{% elseif sliderConfig.navigationArrows.value == "inside" %} is-nav-prev-inside{% endif %}"
                                        aria-label="{{ 'general.previous'|trans|striptags }}"
                                    >
                                        {% sw_icon 'arrow-head-left' %}
                                    </button>
                                    <button
                                        class="base-slider-controls-next hero-category-slider-controls-next{% if sliderConfig.navigationArrows.value == "outside" %} is-nav-next-outside{% elseif sliderConfig.navigationArrows.value == "inside" %} is-nav-next-inside{% endif %}"
                                        aria-label="{{ 'general.next'|trans|striptags }}"
                                    >
                                        {% sw_icon 'arrow-head-right' %}
                                    </button>
                                </div>
                            </div>
                        {% endblock %}
                    {% endif %}
                </div>
            {% if sliderConfig.verticalAlign.value %}
                </div>
            {% endif %}
        {% endblock %}
    </div>

    {% block element_hero_category_slider_target_after_slider %}
        <div id="content-after-target-{{ blockId }}"></div>
    {% endblock %}
{% endblock %}
