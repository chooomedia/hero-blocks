{# 
HOREX CUSTOM CMS ELEMENT: Product Detail Information
=====================================================

SHOPWARE BEST PRACTICES & HOREX CUSTOM STYLING

Layout:
- Left Column: Buy Button + Quantity Selector
- Right Column: Price, Properties, Product Colors

Features:
- Motorcycle Properties (Leistung, Drehmoment, Zylinder)
- Custom Fields Support (Tagline, Badge, Specs Highlight)
- Property Colors Selection
- Custom Button Styling (btn-accent)
- Right-aligned pricing with secondary color
- Quantity selector only for non-motorcycles
- Bootstrap 5 responsive grid

AVAILABLE VARIABLES (from page.product):
=========================================

Basic Info:
- page.product.translated.name                      - Product Name
- page.product.translated.description               - Full Description
- page.product.productNumber                        - SKU
- page.product.ean                                  - EAN Number

Custom Fields (from Admin > Custom Fields):
- page.product.translated.customFields.custom_horex_tagline
- page.product.translated.customFields.custom_horex_badge_text
- page.product.translated.customFields.custom_horex_specs_highlight
- page.product.translated.customFields.custom_horex_specs_short
- page.product.translated.customFields.custom_horex_video_url

Properties (Technische Daten):
- page.product.properties (or sortedProperties)
  - property.group.translated.name                  - Group (e.g. "Leistung")
  - property.translated.name                        - Value (e.g. "161 PS")

Options/Variants:
- page.product.options
  - option.group.translated.name                    - Group (e.g. "Farbe")
  - option.translated.name                          - Value (e.g. "Schwarz")
  - option.colorHexCode                             - Hex Color Code

Pricing:
- page.product.calculatedPrice.totalPrice|currency
- page.product.calculatedTaxes.first.taxRate

Manufacturer:
- page.product.manufacturer.translated.name
- page.product.manufacturer.media
#}

{% set product = page.product %}

{# ==================== DETECT PRODUCT TYPE ==================== #}
{# Check if product is a motorcycle based on product number or custom field #}
{% set customFields = product.translated.customFields ?? product.customFields ?? {} %}
{% set productType = customFields.custom_horex_product_type ?? customFields.horex_product_type ?? '' %}
{% set isMotorcycle = productType == 'motorcycle' 
    or product.productNumber|slice(0, 2) == 'HM' 
    or 'regina evo' in product.translated.name|lower 
    or 'vr6 raw' in product.translated.name|lower 
    or 'vr6' in product.translated.name|lower %}

{# ==================== EXTRACT CUSTOM FIELDS ==================== #}
{% set tagline = customFields.custom_horex_tagline ?? customFields.horex_tagline ?? '' %}
{% set badgeText = customFields.custom_horex_badge_text ?? customFields.horex_badge ?? '' %}
{% set specsHighlight = customFields.custom_horex_specs_highlight ?? customFields.horex_specs_highlight ?? '' %}
{% set specsShort = customFields.custom_horex_specs_short ?? customFields.horex_specs_short ?? '' %}
{% set videoUrl = customFields.custom_horex_video_url ?? customFields.horex_video_url ?? '' %}
{% set highlightFeatures = customFields.custom_horex_highlight_features ?? customFields.horex_highlight_features ?? '' %}
{% set ctaText = customFields.custom_horex_cta_text ?? customFields.horex_cta_text ?? '' %}
{% set ctaUrl = customFields.custom_horex_cta_url ?? customFields.horex_cta_url ?? '' %}

{# ==================== EXTRACT PROPERTIES ==================== #}
{# Use sortedProperties if available (Shopware 6.5+), fallback to properties #}
{% set allProperties = product.sortedProperties ?? product.properties %}
{% set properties = allProperties.elements ?? allProperties %}

{# Build property map by group name for easy access #}
{% set propertyMap = {} %}
{% if properties %}
    {% for property in properties %}
        {% set groupName = property.group.translated.name ?? property.group.name ?? 'Sonstige' %}
        {% set optionName = property.translated.name ?? property.name %}
        {% if groupName and optionName %}
            {% set propertyMap = propertyMap|merge({ (groupName): optionName }) %}
        {% endif %}
    {% endfor %}
{% endif %}

{# Common motorcycle properties for quick access #}
{% set leistung = propertyMap['Leistung'] ?? propertyMap['Power'] ?? propertyMap['PS'] ?? '' %}
{% set drehmoment = propertyMap['Drehmoment'] ?? propertyMap['Torque'] ?? propertyMap['Nm'] ?? '' %}
{% set zylinder = propertyMap['Zylinder'] ?? propertyMap['Cylinders'] ?? '' %}
{% set hubraum = propertyMap['Hubraum'] ?? propertyMap['Displacement'] ?? propertyMap['ccm'] ?? '' %}
{% set gewicht = propertyMap['Gewicht'] ?? propertyMap['Weight'] ?? propertyMap['kg'] ?? '' %}
{% set geschwindigkeit = propertyMap['Höchstgeschwindigkeit'] ?? propertyMap['Top Speed'] ?? propertyMap['km/h'] ?? '' %}

{# ==================== EXTRACT VARIANT OPTIONS ==================== #}
{% set variantOptions = {} %}
{% set colorOptions = [] %}
{% if product.options %}
    {% for option in product.options %}
        {% set groupName = option.group.translated.name ?? option.group.name %}
        {% set optionValue = option.translated.name ?? option.name %}
        {% set colorCode = option.colorHexCode ?? '' %}
        
        {% if groupName %}
            {% set variantOptions = variantOptions|merge({ (groupName): {
                'value': optionValue,
                'colorCode': colorCode,
                'id': option.id,
                'media': option.media ?? null
            }}) %}
            
            {# Collect color options separately #}
            {% if 'color' in groupName|lower or 'farbe' in groupName|lower or colorCode %}
                {% set colorOptions = colorOptions|merge([{
                    'id': option.id,
                    'name': optionValue,
                    'colorCode': colorCode,
                    'media': option.media ?? null
                }]) %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endif %}

{% block cms_element_horex_product_detail %}
<div class="cms-element-horex-product-detail{% if isMotorcycle %} is-motorcycle{% endif %}"
     data-product-id="{{ product.id }}"
     data-product-number="{{ product.productNumber }}"
     data-product-type="{{ productType ?: (isMotorcycle ? 'motorcycle' : 'accessory') }}"
     itemscope
     itemtype="https://schema.org/Product">
    
    <div class="container">
        <div class="row align-items-start gap-4">
            
            {# ==================== LEFT COLUMN: PRODUCT INFO + BUY BUTTON ==================== #}
            <div class="col-12 col-lg-6">
                
                {# Badge (from Custom Field) #}
                {% block horex_product_badge %}
                    {% if badgeText %}
                        <div class="product-detail-badge mb-2">
                            <span class="badge bg-primary">{{ badgeText }}</span>
                        </div>
                    {% endif %}
                {% endblock %}
                
                {# Product Info Header #}
                <div class="product-detail-header mb-4">
                    {% block horex_product_detail_header %}
                        {# Tagline (from Custom Field) #}
                        {% if tagline %}
                            <p class="product-detail-tagline text-uppercase text-muted small mb-2" style="letter-spacing: 1px;">
                                {{ tagline }}
                            </p>
                        {% endif %}
                        
                        <h1 class="product-detail-title h3 fw-bold mb-2" itemprop="name">
                            {{ product.translated.name }}
                        </h1>
                        
                        {# Manufacturer #}
                        {% if product.manufacturer %}
                            <div class="product-detail-manufacturer d-flex align-items-center gap-2 mb-3" 
                                 itemprop="brand" itemscope itemtype="https://schema.org/Brand">
                                {% if product.manufacturer.media %}
                                    <img src="{{ product.manufacturer.media.url }}" 
                                         alt="{{ product.manufacturer.translated.name }}"
                                         class="product-detail-manufacturer-logo"
                                         style="max-height: 24px; width: auto;"
                                         loading="lazy">
                                {% endif %}
                                <span itemprop="name" class="small text-muted">
                                    {{ product.manufacturer.translated.name }}
                                </span>
                            </div>
                        {% endif %}
                        
                        {# Specs Highlight (from Custom Field or Properties) #}
                        {% if specsHighlight %}
                            <div class="product-detail-specs-highlight h5 text-primary mb-3">
                                {{ specsHighlight }}
                            </div>
                        {% elseif isMotorcycle and (leistung or drehmoment or zylinder) %}
                            {# Auto-generate specs highlight from properties #}
                            <div class="product-detail-specs-highlight h5 text-primary mb-3">
                                {% if leistung %}{{ leistung }}{% endif %}
                                {% if drehmoment %}{% if leistung %} | {% endif %}{{ drehmoment }}{% endif %}
                                {% if zylinder %}{% if leistung or drehmoment %} | {% endif %}{{ zylinder }}{% endif %}
                            </div>
                        {% endif %}
                    {% endblock %}
                </div>
                
                {# Short Specs (from Custom Field) #}
                {% block horex_product_specs_short %}
                    {% if specsShort %}
                        <div class="product-detail-specs-short small text-muted mb-4">
                            {{ specsShort|raw }}
                        </div>
                    {% endif %}
                {% endblock %}
                
                {# Motorcycle Properties (Technical Specs) #}
                {% if isMotorcycle and properties|length > 0 %}
                <div class="product-properties-section mb-4">
                    {% block horex_product_properties %}
                        <h4 class="product-properties-title h6 mb-3">
                            {{ 'detail.tabProperties'|trans|default('Technische Daten') }}
                        </h4>
                        
                        <div class="product-properties">
                            {% for property in properties %}
                                {% set groupName = property.group.translated.name ?? property.group.name %}
                                {% set optionName = property.translated.name ?? property.name %}
                                
                                {% if groupName and optionName %}
                                    <div class="property-item mb-2 pb-2 border-bottom d-flex justify-content-between">
                                        {# Property Label #}
                                        <span class="property-label fw-bold text-uppercase small" 
                                              style="font-family: 'Oswald', sans-serif; letter-spacing: 0.5px;">
                                            {{ groupName }}
                                        </span>
                                        
                                        {# Property Value #}
                                        <span class="property-value text-end" 
                                              style="color: var(--bs-secondary, #6c757d);">
                                            {{ optionName }}
                                        </span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endblock %}
                </div>
                {% endif %}
                
                {# Highlight Features (from Custom Field) #}
                {% block horex_product_features %}
                    {% if highlightFeatures %}
                        <div class="product-detail-features mb-4">
                            {{ highlightFeatures|raw }}
                        </div>
                    {% endif %}
                {% endblock %}
                
                {# Buy Section #}
                <div class="product-detail-buy-section">
                    {% block horex_product_buy %}
                        {# Custom CTA (from Custom Field) or Standard Buy Button #}
                        {% if ctaText and ctaUrl %}
                            {# Custom CTA Button #}
                            <a href="{{ ctaUrl }}" class="btn btn-accent btn-lg w-100">
                                {{ ctaText }}
                            </a>
                        {% else %}
                            {# Standard Buy Form #}
                            <form method="post" action="{{ path('frontend.checkout.line-item.add') }}" 
                                  class="product-detail-buy-form"
                                  data-add-to-cart="true">
                                <input type="hidden" name="redirectTo" value="frontend.detail.page">
                                <input type="hidden" name="redirectParameters" value="{{ {productId: product.id}|json_encode }}">
                                <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}">
                                <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}">
                                <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product">
                                <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1">
                                <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1">
                                <input type="hidden" name="product-name" value="{{ product.translated.name }}">
                                
                                <div class="row gap-2">
                                    {# Quantity Selector (only for non-motorcycles) #}
                                    {% if not isMotorcycle %}
                                    <div class="col-12 col-sm-auto">
                                        <fieldset class="d-flex align-items-center gap-2">
                                            <legend class="visually-hidden">{{ 'component.product.quantity'|trans }}</legend>
                                            
                                            <div class="input-group" data-quantity-selector="true">
                                                <button type="button" class="btn btn-outline-secondary btn-sm js-btn-minus" 
                                                        aria-label="{{ 'component.product.quantity.decrease'|trans }}">
                                                    {% sw_icon 'minus' style { 'size': 'xs' } %}
                                                </button>
                                                <input type="number" name="lineItems[{{ product.id }}][quantity]" 
                                                       class="form-control form-control-sm quantity-selector text-center" 
                                                       min="{{ product.minPurchase ?? 1 }}" 
                                                       max="{{ product.maxPurchase ?? 100 }}" 
                                                       step="{{ product.purchaseSteps ?? 1 }}" 
                                                       value="{{ product.minPurchase ?? 1 }}"
                                                       aria-label="{{ 'component.product.quantity'|trans }}">
                                                <button type="button" class="btn btn-outline-secondary btn-sm js-btn-plus" 
                                                        aria-label="{{ 'component.product.quantity.increase'|trans }}">
                                                    {% sw_icon 'plus' style { 'size': 'xs' } %}
                                                </button>
                                            </div>
                                        </fieldset>
                                    </div>
                                    {% else %}
                                        <input type="hidden" name="lineItems[{{ product.id }}][quantity]" value="1">
                                    {% endif %}
                                    
                                    {# Buy Button #}
                                    <div class="col-12 col-sm-auto">
                                        <button type="submit" class="btn btn-accent btn-lg w-100" 
                                                aria-label="{{ 'checkout.cartAddProduct'|trans }}"
                                                {% if product.availableStock <= 0 and product.isCloseout %}disabled{% endif %}>
                                            {% sw_icon 'bag' %}
                                            <span class="btn-text ms-2">
                                                {{ 'checkout.cartAddProduct'|trans }}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        {% endif %}
                    {% endblock %}
                </div>
            </div>
            
            {# ==================== RIGHT COLUMN: PRICE + OPTIONS ==================== #}
            <div class="col-12 col-lg-6">
                
                {# Price Section #}
                <div class="product-detail-price-section mb-4 text-end">
                    {% block horex_product_price %}
                        <div class="product-detail-price-container" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                            <meta itemprop="priceCurrency" content="{{ context.currency.isoCode }}">
                            <meta itemprop="availability" content="https://schema.org/{% if product.availableStock > 0 %}InStock{% else %}OutOfStock{% endif %}">
                            
                            {# Main Price #}
                            {% if product.calculatedPrice %}
                                <p class="product-detail-price h3 mb-2 text-end" style="color: var(--bs-primary);">
                                    <meta itemprop="price" content="{{ product.calculatedPrice.totalPrice }}">
                                    <strong>{{ product.calculatedPrice.totalPrice|currency }}</strong>
                                </p>
                                
                                {# Reference Price (if applicable) #}
                                {% if product.calculatedPrice.referencePrice %}
                                    <p class="product-detail-reference-price small text-muted mb-2 text-end">
                                        ({{ product.calculatedPrice.referencePrice.price|currency }} / {{ product.calculatedPrice.referencePrice.referenceUnit }} {{ product.calculatedPrice.referencePrice.unitName }})
                                    </p>
                                {% endif %}
                            {% endif %}
                            
                            {# Tax Info #}
                            {% if product.calculatedTaxes|length > 0 %}
                                {% set tax = product.calculatedTaxes.first %}
                                <p class="product-detail-tax small text-muted mb-0 text-end">
                                    {{ 'detail.priceIncludesTax'|trans({ '%tax%': tax.taxRate })|default('inkl. ' ~ tax.taxRate ~ '% MwSt.') }}
                                </p>
                            {% endif %}
                            
                            {# Shipping Info #}
                            <p class="product-detail-shipping small text-muted text-end">
                                {{ 'detail.deliveryShippingFree'|trans|default('zzgl. Versandkosten') }}
                            </p>
                        </div>
                    {% endblock %}
                </div>
                
                {# Color/Variant Selection #}
                {% if product.options|length > 0 %}
                <div class="product-detail-options-section mb-4">
                    {% block horex_product_options %}
                        <div class="product-options">
                            {% for option in product.options %}
                                {% set groupName = option.group.translated.name ?? option.group.name %}
                                {% set optionValue = option.translated.name ?? option.name %}
                                {% set colorCode = option.colorHexCode ?? '' %}
                                {% set isColorOption = 'color' in groupName|lower or 'farbe' in groupName|lower or colorCode %}
                                
                                <div class="option-group mb-3">
                                    <label class="form-label fw-bold mb-2">
                                        {{ groupName }}: <span class="fw-normal">{{ optionValue }}</span>
                                    </label>
                                    
                                    {% if isColorOption and colorCode %}
                                        {# Color Swatch Display #}
                                        <div class="color-swatch-container d-flex gap-2">
                                            <span class="color-swatch active" 
                                                  style="background-color: {{ colorCode }}; width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--bs-primary); display: inline-block;"
                                                  title="{{ optionValue }}"
                                                  data-color-code="{{ colorCode }}">
                                            </span>
                                        </div>
                                    {% else %}
                                        {# Text Display for non-color options #}
                                        <div class="option-value p-2 border rounded bg-light">
                                            {{ optionValue }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endblock %}
                </div>
                {% endif %}
                
                {# Stock/Availability Info #}
                {% block horex_product_availability %}
                    <div class="product-detail-availability mb-4 text-end">
                        {% if product.availableStock is defined and product.availableStock > 0 %}
                            <span class="text-success d-inline-flex align-items-center gap-1">
                                {% sw_icon 'checkmark-circle' style { 'size': 'xs' } %}
                                {{ 'detail.deliveryAvailable'|trans|default('Auf Lager') }}
                            </span>
                        {% elseif product.isCloseout %}
                            <span class="text-danger d-inline-flex align-items-center gap-1">
                                {% sw_icon 'times-circle' style { 'size': 'xs' } %}
                                {{ 'detail.deliveryNotAvailable'|trans|default('Nicht verfügbar') }}
                            </span>
                        {% else %}
                            <span class="text-warning d-inline-flex align-items-center gap-1">
                                {% sw_icon 'clock' style { 'size': 'xs' } %}
                                {{ 'detail.deliveryShippingLater'|trans|default('Lieferzeit auf Anfrage') }}
                            </span>
                        {% endif %}
                    </div>
                {% endblock %}
                
                {# Additional Product Info #}
                <div class="product-detail-info mt-4 text-end">
                    {% block horex_product_additional_info %}
                        {% if product.productNumber %}
                            <p class="small text-muted mb-2">
                                <strong>{{ 'detail.productNumber'|trans|default('Artikelnr.') }}:</strong> 
                                <span itemprop="sku">{{ product.productNumber }}</span>
                            </p>
                        {% endif %}
                        
                        {% if product.ean %}
                            <p class="small text-muted mb-2">
                                <strong>{{ 'detail.dataSheetEan'|trans|default('EAN') }}:</strong> 
                                <span itemprop="gtin13">{{ product.ean }}</span>
                            </p>
                        {% endif %}
                        
                        {# Weight (if defined) #}
                        {% if product.weight %}
                            <p class="small text-muted mb-0">
                                <strong>{{ 'detail.weight'|trans|default('Gewicht') }}:</strong> 
                                {{ product.weight }} kg
                            </p>
                        {% endif %}
                    {% endblock %}
                </div>
            </div>
            
        </div>
        
        {# ==================== VIDEO (from Custom Field) ==================== #}
        {% block horex_product_video %}
            {% if videoUrl %}
                <div class="product-detail-video mt-5">
                    <h4 class="h5 mb-3">{{ 'detail.video'|trans|default('Video') }}</h4>
                    {% if 'youtube.com' in videoUrl or 'youtu.be' in videoUrl %}
                        {% set videoId = videoUrl|split('v=')|last|split('&')|first %}
                        {% if 'youtu.be' in videoUrl %}
                            {% set videoId = videoUrl|split('/')|last|split('?')|first %}
                        {% endif %}
                        <div class="ratio ratio-16x9">
                            <iframe src="https://www.youtube.com/embed/{{ videoId }}" 
                                    title="{{ product.translated.name }} Video"
                                    allowfullscreen
                                    loading="lazy">
                            </iframe>
                        </div>
                    {% elseif 'vimeo.com' in videoUrl %}
                        {% set videoId = videoUrl|split('/')|last %}
                        <div class="ratio ratio-16x9">
                            <iframe src="https://player.vimeo.com/video/{{ videoId }}" 
                                    title="{{ product.translated.name }} Video"
                                    allowfullscreen
                                    loading="lazy">
                            </iframe>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        {% endblock %}
        
        {# ==================== DEBUG (only in dev) ==================== #}
        {% if app.environment == 'dev' and app.request.query.get('debug') %}
            {% block horex_product_debug %}
                <div class="product-detail-debug mt-5 p-3 bg-light border rounded">
                    <h5>Debug: Available Product Data</h5>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="mt-3">Custom Fields:</h6>
                            <pre class="small bg-white p-2 rounded">{{ customFields|json_encode(constant('JSON_PRETTY_PRINT'))|raw }}</pre>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mt-3">Properties Map:</h6>
                            <pre class="small bg-white p-2 rounded">{{ propertyMap|json_encode(constant('JSON_PRETTY_PRINT'))|raw }}</pre>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mt-3">Variant Options:</h6>
                            <pre class="small bg-white p-2 rounded">{{ variantOptions|json_encode(constant('JSON_PRETTY_PRINT'))|raw }}</pre>
                        </div>
                    </div>
                    
                    <h6 class="mt-3">Detected Values:</h6>
                    <ul class="small">
                        <li><strong>isMotorcycle:</strong> {{ isMotorcycle ? 'true' : 'false' }}</li>
                        <li><strong>productType:</strong> {{ productType ?: '(not set)' }}</li>
                        <li><strong>tagline:</strong> {{ tagline ?: '(not set)' }}</li>
                        <li><strong>badgeText:</strong> {{ badgeText ?: '(not set)' }}</li>
                        <li><strong>specsHighlight:</strong> {{ specsHighlight ?: '(not set)' }}</li>
                        <li><strong>leistung:</strong> {{ leistung ?: '(not set)' }}</li>
                        <li><strong>drehmoment:</strong> {{ drehmoment ?: '(not set)' }}</li>
                        <li><strong>zylinder:</strong> {{ zylinder ?: '(not set)' }}</li>
                    </ul>
                </div>
            {% endblock %}
        {% endif %}
        
    </div>
</div>
{% endblock %}
