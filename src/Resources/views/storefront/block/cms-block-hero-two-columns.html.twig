{% block block_hero_two_columns %}
    {# WICHTIG: Config-Werte aus block.customFields lesen (NICHT block.config!) #}
    {# CmsBlockEntity nutzt EntityCustomFieldsTrait - Config wird in customFields gespeichert #}
    
    {# WICHTIG: License-Check - Prüft ob Premium-Feature verfügbar ist #}
    {% set licenseStatus = config('HeroBlocks.config.licenseStatus')|default('active') %}
    
    {# License-Hinweis anzeigen wenn abgelaufen (vor Block-Content) #}
    {% if licenseStatus == 'expired' %}
        <div class="col-12">
            {% include '@HeroBlocks/storefront/component/license-expired-notice.html.twig' with {
                feature: 'Hero Two Columns',
                licenseStatus: licenseStatus
            } only %}
        </div>
    {% endif %}
    
    {% set layout = (block.customFields.layout is defined and block.customFields.layout is not empty) ? block.customFields.layout : 'image-left' %}
    {% set layoutDesktop = (block.customFields.layoutDesktop is defined and block.customFields.layoutDesktop is not empty) ? block.customFields.layoutDesktop : layout %}
    {% set layoutTablet = (block.customFields.layoutTablet is defined and block.customFields.layoutTablet is not empty) ? block.customFields.layoutTablet : layout %}
    {% set backgroundMode = (block.customFields.backgroundMode is defined) ? block.customFields.backgroundMode : 'none' %}
    
    {# WICHTIG: minHeight nur setzen wenn es existiert UND nicht calc(100vh...) enthält #}
    {# calc(100vh...) Werte werden ignoriert (werden nur bei fullHeight verwendet) #}
    {% set minHeight = null %}
    {% if block.customFields.minHeight is defined and block.customFields.minHeight is not null and block.customFields.minHeight is not empty %}
        {% set minHeightValue = block.customFields.minHeight|trim %}
        {# WICHTIG: Ignoriere calc(100vh...) Werte - diese werden nur bei fullHeight verwendet #}
        {% if minHeightValue|length > 0 and 'calc(100vh' not in minHeightValue %}
            {% set minHeight = minHeightValue %}
        {% endif %}
    {% endif %}
    
    {# Background Images - WICHTIG: Media-URLs korrekt generieren #}
    {% set backgroundImage = (block.customFields.backgroundImage is defined) ? block.customFields.backgroundImage : null %}
    {% set backgroundImageLeft = (block.customFields.backgroundImageLeft is defined) ? block.customFields.backgroundImageLeft : null %}
    {% set backgroundImageRight = (block.customFields.backgroundImageRight is defined) ? block.customFields.backgroundImageRight : null %}
    {% set backgroundZIndex = (block.customFields.backgroundZIndex is defined) ? block.customFields.backgroundZIndex : '0' %}
    
    {# Background CSS Code Toggle #}
    {% set backgroundLeftUseCss = (block.customFields.backgroundLeftUseCss is defined) ? block.customFields.backgroundLeftUseCss : false %}
    {% set backgroundRightUseCss = (block.customFields.backgroundRightUseCss is defined) ? block.customFields.backgroundRightUseCss : false %}
    {% set backgroundLeftCss = (block.customFields.backgroundLeftCss is defined and block.customFields.backgroundLeftCss is not empty) ? block.customFields.backgroundLeftCss : 'background: repeating-linear-gradient(123deg, #46494A 0px, #46494A 6px, transparent 6px, transparent 12px);' %}
    {% set backgroundRightCss = (block.customFields.backgroundRightCss is defined and block.customFields.backgroundRightCss is not empty) ? block.customFields.backgroundRightCss : 'background: repeating-linear-gradient(123deg, #46494A 0px, #46494A 6px, transparent 6px, transparent 12px);' %}
    
    {# Scroll Animation Settings #}
    {% set scrollAnimationAngle = (block.customFields.scrollAnimationAngle is defined and block.customFields.scrollAnimationAngle is not empty) ? block.customFields.scrollAnimationAngle : '33' %}
    {% set scrollAnimationEnabled = (block.customFields.scrollAnimationEnabled is defined) ? block.customFields.scrollAnimationEnabled : true %}
    
    {# Media-URLs generieren mit Twig Extension (nur wenn nicht CSS Code verwendet wird) #}
    {% set backgroundImageUrl = backgroundImage ? hero_media_url(backgroundImage) : null %}
    {% set backgroundImageLeftUrl = (backgroundLeftUseCss == false and backgroundImageLeft) ? hero_media_url(backgroundImageLeft) : null %}
    {% set backgroundImageRightUrl = (backgroundRightUseCss == false and backgroundImageRight) ? hero_media_url(backgroundImageRight) : null %}
    
    {# Audio-Datei #}
    {% set audioFile = (block.customFields.audioFile is defined) ? block.customFields.audioFile : null %}
    {% set audioFileUrl = audioFile ? hero_media_url(audioFile) : null %}
    
    {# Element Positionierung - Left Slot #}
    {% set elementLeftTranslateX = (block.customFields.elementLeftTranslateX is defined) ? block.customFields.elementLeftTranslateX : '0' %}
    {% set elementLeftTranslateY = (block.customFields.elementLeftTranslateY is defined) ? block.customFields.elementLeftTranslateY : '0' %}
    {% set elementLeftAnimate = (block.customFields.elementLeftAnimate is defined) ? block.customFields.elementLeftAnimate : false %}
    
    {# Element Positionierung - Right Slot #}
    {% set elementRightTranslateX = (block.customFields.elementRightTranslateX is defined) ? block.customFields.elementRightTranslateX : '0' %}
    {% set elementRightTranslateY = (block.customFields.elementRightTranslateY is defined) ? block.customFields.elementRightTranslateY : '0' %}
    {% set elementRightAnimate = (block.customFields.elementRightAnimate is defined) ? block.customFields.elementRightAnimate : false %}

    {# WICHTIG: Background-Bilder werden auf .cms-block Level gerendert (wie Standard-Block) #}
    {# Background Mode: Single Image #}
    {% if backgroundMode == 'single' and backgroundImageUrl %}
            <div class="hero-two-columns-background hero-two-columns-background--single" 
             style="background-image: url('{{ backgroundImageUrl }}'); z-index: {{ backgroundZIndex }};">
            </div>
    {% endif %}

    {# Background Mode: Two Images (Parallax) #}
    {% if backgroundMode == 'two-images' %}
            {# Background Left: Image oder CSS Code #}
            {% if backgroundLeftUseCss %}
                {# WICHTIG: CSS Code mit z-index kombinieren #}
                {% set backgroundLeftStyle = backgroundLeftCss|trim %}
                {% if backgroundLeftStyle|slice(-1) != ';' %}
                    {% set backgroundLeftStyle = backgroundLeftStyle ~ ';' %}
                {% endif %}
                {% set backgroundLeftStyle = backgroundLeftStyle ~ ' z-index: ' ~ backgroundZIndex ~ ';' %}
                <div class="hero-two-columns-background hero-two-columns-background--left" 
                     {% if scrollAnimationEnabled %}data-parallax-background="left"{% endif %}
                     data-scroll-animation-angle="{{ scrollAnimationAngle }}"
                     data-scroll-animation-enabled="{{ scrollAnimationEnabled ? 'true' : 'false' }}"
                     style="{{ backgroundLeftStyle|raw }}">
                </div>
            {% elseif backgroundImageLeftUrl %}
                <div class="hero-two-columns-background hero-two-columns-background--left" 
                     {% if scrollAnimationEnabled %}data-parallax-background="left"{% endif %}
                     data-scroll-animation-angle="{{ scrollAnimationAngle }}"
                     data-scroll-animation-enabled="{{ scrollAnimationEnabled ? 'true' : 'false' }}"
                     style="background-image: url('{{ backgroundImageLeftUrl }}'); z-index: {{ backgroundZIndex }};">
                </div>
            {% endif %}
            
            {# Background Right: Image oder CSS Code #}
            {% if backgroundRightUseCss %}
                {# WICHTIG: CSS Code mit z-index kombinieren #}
                {% set backgroundRightStyle = backgroundRightCss|trim %}
                {% if backgroundRightStyle|slice(-1) != ';' %}
                    {% set backgroundRightStyle = backgroundRightStyle ~ ';' %}
                {% endif %}
                {% set backgroundRightStyle = backgroundRightStyle ~ ' z-index: ' ~ backgroundZIndex ~ ';' %}
                <div class="hero-two-columns-background hero-two-columns-background--right" 
                     {% if scrollAnimationEnabled %}data-parallax-background="right"{% endif %}
                     data-scroll-animation-angle="{{ scrollAnimationAngle }}"
                     data-scroll-animation-enabled="{{ scrollAnimationEnabled ? 'true' : 'false' }}"
                     style="{{ backgroundRightStyle|raw }}">
                </div>
            {% elseif backgroundImageRightUrl %}
                <div class="hero-two-columns-background hero-two-columns-background--right" 
                     {% if scrollAnimationEnabled %}data-parallax-background="right"{% endif %}
                     data-scroll-animation-angle="{{ scrollAnimationAngle }}"
                     data-scroll-animation-enabled="{{ scrollAnimationEnabled ? 'true' : 'false' }}"
                     style="background-image: url('{{ backgroundImageRightUrl }}'); z-index: {{ backgroundZIndex }};">
                </div>
            {% endif %}
    {% endif %}

    {# WICHTIG: Bei full-width Section: Container um Content-Elemente für innere Breite #}
    {% set isFullWidth = section.sizingMode == 'full_width' %}
    {% if isFullWidth %}
        <div class="container hero-two-columns-content-container">
            <div class="row">
    {% endif %}
    
    {# WICHTIG: Cols müssen direkte Kinder der .row sein (wie Standard image-text Block) #}
    {# Desktop/Tablet: 2 Spalten (50/50), Mobile: Stacked (100%) #}
    {% block block_hero_two_columns_content %}
        {# Left Slot (Bild) - Direktes Kind der .row für Bootstrap Grid #}
        {% block block_hero_two_columns_left %}
            {% set element = block.slots.getSlot('left') %}
            {% if element and element.type %}
                {# WICHTIG: Bootstrap Order-Klassen für Responsive Layout #}
                {# layout: Mobile, layoutTablet: Tablet, layoutDesktop: Desktop #}
                {% set mobileOrder = layout == 'text-left' ? '2' : '1' %}
                {% set tabletOrder = layoutTablet == 'text-left' ? '2' : '1' %}
                {% set desktopOrder = layoutDesktop == 'text-left' ? '2' : '1' %}
                {% set orderClasses = 'order-' ~ mobileOrder ~ ' order-md-' ~ tabletOrder ~ ' order-lg-' ~ desktopOrder %}
                
                {# WICHTIG: min-height aus Admin-Settings anwenden #}
                {% set columnStyle = '' %}
                {% if minHeight %}
                    {% set columnStyle = 'min-height: ' ~ minHeight ~ ';' %}
                {% endif %}
                
                <div class="col-md-6 {{ orderClasses }}" data-cms-element-id="{{ element.id }}" {% if columnStyle %}style="{{ columnStyle }}"{% endif %}>
                    {% block block_hero_two_columns_left_inner %}
                        {# WICHTIG: Wrapper für Element-Positionierung und Animation #}
                        <div class="hero-two-columns-element-wrapper hero-two-columns-element-wrapper--left"
                             {% if elementLeftAnimate %}data-scroll-animate="true"{% endif %}
                             data-translate-x="{{ elementLeftTranslateX }}"
                             data-translate-y="{{ elementLeftTranslateY }}">
                            {% sw_include '@Storefront/storefront/element/cms-element-' ~ element.type ~ '.html.twig' ignore missing %}
                        </div>
                    {% endblock %}
                    </div>
            {% endif %}
        {% endblock %}

        {# Right Slot (Text) - Direktes Kind der .row für Bootstrap Grid #}
        {% block block_hero_two_columns_right %}
            {% set element = block.slots.getSlot('right') %}
            {% if element and element.type %}
                {# WICHTIG: Bootstrap Order-Klassen für Responsive Layout (invers zu left) #}
                {% set mobileOrder = layout == 'text-left' ? '1' : '2' %}
                {% set tabletOrder = layoutTablet == 'text-left' ? '1' : '2' %}
                {% set desktopOrder = layoutDesktop == 'text-left' ? '1' : '2' %}
                {% set orderClasses = 'order-' ~ mobileOrder ~ ' order-md-' ~ tabletOrder ~ ' order-lg-' ~ desktopOrder %}
                
                {# WICHTIG: min-height aus Admin-Settings anwenden #}
                {% set columnStyle = '' %}
                {% if minHeight %}
                    {% set columnStyle = 'min-height: ' ~ minHeight ~ ';' %}
                {% endif %}
                
                <div class="col-md-6 {{ orderClasses }}" data-cms-element-id="{{ element.id }}" {% if columnStyle %}style="{{ columnStyle }}"{% endif %}>
                    {% block block_hero_two_columns_right_inner %}
                        {# WICHTIG: Wrapper für Element-Positionierung und Animation #}
                        <div class="hero-two-columns-element-wrapper hero-two-columns-element-wrapper--right"
                             {% if elementRightAnimate %}data-scroll-animate="true"{% endif %}
                             data-translate-x="{{ elementRightTranslateX }}"
                             data-translate-y="{{ elementRightTranslateY }}">
                            {% sw_include '@Storefront/storefront/element/cms-element-' ~ element.type ~ '.html.twig' ignore missing %}
                        </div>
                    {% endblock %}
                    </div>
            {% endif %}
        {% endblock %}
    {% endblock %}
    
    {# WICHTIG: Bei full-width Section: Container schließen #}
    {% if isFullWidth %}
            </div> {# row #}
        </div> {# container #}
    {% endif %}
    
    {# WICHTIG: Parallax JavaScript - inline für garantierte Verfügbarkeit #}
    <script>
    (function() {
        'use strict';
        
        // Prüfen ob bereits initialisiert
        if (window.HeroTwoColumnsParallaxInitialized) return;
        window.HeroTwoColumnsParallaxInitialized = true;
        
        console.log('[HeroTwoColumns] Parallax Script loaded');
        
        function initParallax() {
            const sections = document.querySelectorAll('[data-hero-two-columns-parallax]');
            console.log('[HeroTwoColumns] Found sections:', sections.length);
            
            if (sections.length === 0) return;
            
            sections.forEach(section => {
                const backgrounds = section.querySelectorAll('[data-parallax-background]');
                const elements = section.querySelectorAll('[data-scroll-animate="true"]');
                
                console.log('[HeroTwoColumns] Section:', section, 'Backgrounds:', backgrounds.length, 'Elements:', elements.length);
                
                // Initial-Positionierung: Von außen (links/rechts), im 33° Winkel
                // WICHTIG: Erst animieren wenn KOMPLETTE Section im Viewport!
                backgrounds.forEach(bg => {
                    const direction = bg.getAttribute('data-parallax-background');
                    const angle = parseFloat(bg.getAttribute('data-scroll-animation-angle') || '33');
                    const enabled = bg.getAttribute('data-scroll-animation-enabled') !== 'false';
                    
                    if (enabled) {
                        // Initial von außen: Links -100vw, Rechts +100vw
                        if (direction === 'left') {
                            bg.style.transform = 'translateX(-100vw) rotate(' + angle + 'deg)';
                        } else {
                            bg.style.transform = 'translateX(100vw) rotate(' + angle + 'deg)';
                        }
                        bg.style.transition = 'transform 1200ms cubic-bezier(0.4, 0, 0.2, 1)';
                        console.log('[HeroTwoColumns] Initial positioning:', direction, 'from outside ±100vw');
                    }
                });
                
                // Element initial positioning
                // WICHTIG: Elemente IMMER sichtbar (opacity: 1)!
                // Nur Position ändert sich wenn Animation aktiviert
                elements.forEach(el => {
                    const x = el.getAttribute('data-translate-x') || '0';
                    const y = el.getAttribute('data-translate-y') || '0';
                    
                    // WICHTIG: Immer sichtbar!
                    el.style.opacity = '1';
                    el.style.transform = `translate(${x}px, ${y}px)`;
                    el.style.transition = 'transform 1000ms cubic-bezier(0.4, 0, 0.2, 1)';
                });
                
                // Scroll-Handler
                let ticking = false;
                function onScroll() {
                    if (!ticking) {
                        window.requestAnimationFrame(() => {
                            updateParallax(section, backgrounds, elements);
                            ticking = false;
                        });
                        ticking = true;
                    }
                }
                
                window.addEventListener('scroll', onScroll, { passive: true });
                window.addEventListener('resize', onScroll);
                
                // Initial update
                updateParallax(section, backgrounds, elements);
            });
        }
        
        function updateParallax(section, backgrounds, elements) {
            const rect = section.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            // WICHTIG: Nur animieren wenn Section teilweise sichtbar
            if (rect.top > viewportHeight || rect.bottom < 0) return;
            
            // WICHTIG: Komplette Section muss im Viewport sein für Background-Animation
            const sectionFullyVisible = rect.top <= 0 && rect.bottom >= viewportHeight;
            const sectionEnteredViewport = rect.top < viewportHeight;
            
            // Background slide-in: Von außen (±100vw) nach innen (0vw)
            backgrounds.forEach(bg => {
                const direction = bg.getAttribute('data-parallax-background');
                const angle = parseFloat(bg.getAttribute('data-scroll-animation-angle') || '33');
                const enabled = bg.getAttribute('data-scroll-animation-enabled') !== 'false';
                
                if (enabled && !bg.classList.contains('is--slided-in')) {
                    // Slide-in wenn Section im Viewport
                    if (sectionEnteredViewport) {
                        bg.style.transform = 'translateX(0) rotate(' + angle + 'deg)';
                        bg.classList.add('is--slided-in');
                        console.log('[HeroTwoColumns] Background slided in:', direction);
                    }
                }
            });
            
            // Element animations (nur Position, keine opacity!)
            elements.forEach(el => {
                if (el.classList.contains('is--animated')) return;
                
                const elRect = el.getBoundingClientRect();
                if (elRect.top < viewportHeight - 150) {
                    // Smooth slide-in to center (opacity bleibt 1!)
                    el.style.transform = 'translate(0, 0)';
                    el.classList.add('is--animated');
                    console.log('[HeroTwoColumns] Element animated');
                }
            });
        }
        
        // Init on DOMContentLoaded oder sofort wenn DOM bereits geladen
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initParallax);
        } else {
            initParallax();
        }
    })();
    </script>
{% endblock %}
